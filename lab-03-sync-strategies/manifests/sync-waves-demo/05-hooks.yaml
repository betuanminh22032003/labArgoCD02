# 05-hooks.yaml - Sync Hooks Demo
# PreSync: Ch·∫°y TR∆Ø·ªöC khi b·∫•t k·ª≥ wave n√†o ƒë∆∞·ª£c deploy
# PostSync: Ch·∫°y SAU khi T·∫§T C·∫¢ waves ƒë√£ deploy v√† healthy
---
# ============================================================
# PreSync Hook: Ch·∫°y tr∆∞·ªõc khi deploy
# Use cases: Database migrations, config validation, backup
# ============================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: pre-sync-check
  namespace: waves-demo
  annotations:
    # Hook type: PreSync ch·∫°y tr∆∞·ªõc t·∫•t c·∫£
    argocd.argoproj.io/hook: PreSync
    # T·ª± ƒë·ªông x√≥a Job sau khi th√†nh c√¥ng
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    # C√≥ th·ªÉ set wave cho hooks n·∫øu c√≥ nhi·ªÅu hooks
    argocd.argoproj.io/sync-wave: "-5"
spec:
  # T·ª± ƒë·ªông x√≥a Job sau 60 gi√¢y (Kubernetes feature)
  ttlSecondsAfterFinished: 60
  template:
    spec:
      containers:
        - name: pre-check
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "=========================================="
              echo "üîç PreSync Hook: Running pre-deployment checks..."
              echo "üìÖ Time: $(date)"
              echo ""
              echo "Simulating checks..."
              sleep 2
              echo "‚úÖ Database connection: OK"
              sleep 1
              echo "‚úÖ Config validation: OK"
              sleep 1
              echo "‚úÖ Dependencies check: OK"
              echo ""
              echo "=========================================="
              echo "‚úÖ PreSync completed successfully!"
              echo "=========================================="
      restartPolicy: Never
  # S·ªë l·∫ßn retry n·∫øu Job fail
  backoffLimit: 1

---
# ============================================================
# PostSync Hook: Ch·∫°y sau khi t·∫•t c·∫£ resources ƒë√£ healthy
# Use cases: Smoke tests, notifications, cache warm-up
# ============================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: post-sync-test
  namespace: waves-demo
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      containers:
        - name: smoke-test
          image: curlimages/curl:8.4.0
          command:
            - /bin/sh
            - -c
            - |
              echo "=========================================="
              echo "üß™ PostSync Hook: Running smoke tests..."
              echo "üìÖ Time: $(date)"
              echo ""
              
              echo "Testing service endpoint..."
              
              # Th·ª≠ g·ªçi service (retry 5 l·∫ßn)
              for i in 1 2 3 4 5; do
                echo "Attempt $i/5..."
                if curl -sf http://wave-app-service.waves-demo.svc.cluster.local/ > /dev/null 2>&1; then
                  echo ""
                  echo "‚úÖ Service is responding!"
                  echo "=========================================="
                  echo "‚úÖ All smoke tests passed!"
                  echo "=========================================="
                  exit 0
                fi
                echo "Service not ready yet, waiting..."
                sleep 3
              done
              
              # N·∫øu fail sau 5 l·∫ßn, v·∫´n exit 0 ƒë·ªÉ kh√¥ng block
              # Trong production c√≥ th·ªÉ exit 1 ƒë·ªÉ b√°o l·ªói
              echo ""
              echo "‚ö†Ô∏è Service check inconclusive but continuing..."
              echo "=========================================="
              exit 0
      restartPolicy: Never
  backoffLimit: 2
